---
title: "Code Checking"
output: html_notebook
---

```{r}
df <- readRDS("data/mean_travel_time_ranking_2011.rds")
mean <- 23.8
sd <- 3.6 #2 #3.6 #c(2, 3.6, 6)
K <- c(10)#(51, 40, 30, 20, 10, 5)
corr <- c(0.5)#,0.5,0.9)
alpha <- c(0.05)#c(0.05, 0.1, 0.15, 0.2)
B <- 600

set.seed(123974)
true_theta <- rnorm(K, mean, sd)
true_sds <- df$S[1:K]
    
true_theta
```

```{r}
true_sds


# a<-c(9, 6, 10)
# b<-c(1, 3, 1)
# c<-c(4, 3, 3)
# (a-b)/c

```
```{r}
corr
```


```{r}
corr_matrix <- (1 - corr) * diag(K) + corr * matrix(1, K, K)
variance_vector <- true_sds^2
delta <- diag(variance_vector)
varcovar_matrix <- delta^(1/2) %*% corr_matrix %*% delta^(1/2)
varcovar_matrix
```

```{r}
variance_vector <- diag(varcovar_matrix)
sqrt(variance_vector) ==  true_sds
```








```{r}
# source("R/compute_metrics.R")
# stopImplicitCluster()
# library(doRNG)
# registerDoSEQ()
# 
# df <- readRDS("data/mean_travel_time_ranking_2011.rds")
# mean <- 23.8
# sds <- c(2, 3.6, 6)
# K <- c(10)#(51, 40, 30, 20, 10, 5)
# corr <- c(0.1,0.5)
# 
# for (sd in sds) {
#   for (r in corr) {
#   print(cat("RESULTS FOR SD",sd, 'CORRELATION', r))
#   corr_matrix <- (1 - r) * diag(K) + r * matrix(1, K, K)
# 
#   set.seed(123974)
#   true_theta <- rnorm(K, mean, sd)
#   print(true_theta)
#   print(true_sds)
#   true_sds <- df$S[1:K]
#   variance_vector <- true_sds^2
#   delta <- diag(variance_vector)
#   varcovar_matrix <- delta^(1/2) %*% corr_matrix %*% delta^(1/2)
#   out <- implement_algorithm2(
#       true_theta = true_theta,
#       K = K, 
#       reps=2, # step 4
#       B=10, 
#       alpha= 0.05,
#       C=6,
#       varcovar_matrix = varcovar_matrix)
#   case_end <- Sys.time()
#           case_runtime <- as.numeric(difftime(case_end, case_start, units = "mins"))
#           cat("Finished at:", format(case_end, "%I:%M %p"), "\n")
#           cat("Runtime for this case:", round(case_runtime, 2), "minutes\n")
#   
#   # print(colMeans(out))
#   filename <- paste0(
#     paste(paste0("K",gsub("\\.", "p", as.character(K))),
#           paste0("sd",gsub("\\.", "p", as.character(sd))),
#           paste0("r",gsub("\\.", "p", as.character(r))),
#           sep = "_"),
#     ".rds")
#   
#   # saveRDS(out, file = filename)
# }
# }
# 
# # stopCluster(cl)
# #1.964865
# 
# # 1.964873 mali
```

```{r}
print(cat("hi",K))
```



```{r}
source("R/compute_metrics.R")
library(doParallel)
cl=parallel::makeCluster(15)
registerDoParallel(cl)
case_start <- Sys.time()


df <- readRDS("data/mean_travel_time_ranking_2011.rds")
mean <- 23.8
sds <- c(2, 3.6, 6)
K <- c(10)#(51, 40, 30, 20, 10, 5)
corr <- c(0.1,0.5)

for (sd in sds) {
  for (r in corr) {
  print(cat("RESULTS FOR SD",sd, 'CORRELATION', r))
  corr_matrix <- (1 - r) * diag(K) + r * matrix(1, K, K)

  set.seed(123974)
  true_theta <- rnorm(K, mean, sd)
  true_sds <- df$S[1:K]
  variance_vector <- true_sds^2
  delta <- diag(variance_vector)
  varcovar_matrix <- delta^(1/2) %*% corr_matrix %*% delta^(1/2)
  out <- implement_algorithm2(
      true_theta = true_theta,
      K = K, 
      reps=5000, # step 4
      B=500, 
      alpha= 0.05,
      C=300,
      varcovar_matrix = varcovar_matrix)
  case <- paste(paste0("K",gsub("\\.", "p", as.character(K))),
          paste0("sd",gsub("\\.", "p", as.character(sd))),
          paste0("r",gsub("\\.", "p", as.character(r))),
          sep = "_")
  case_end <- Sys.time()
          case_runtime <- as.numeric(difftime(case_end, case_start, units = "mins"))
          cat("Finished at:", format(case_end, "%I:%M %p"), "\n")
          cat("Runtime for", case, round(case_runtime, 2), "minutes\n")
  
  print(colMeans(out))
  filename <- paste0(
    case,
    ".rds")
  
  saveRDS(out, file = filename)
}
}
stopCluster(cl)
```

```{r}
colMeans(readRDS("K10_sd3p6_r0p1.rds"))
```


```{r}
filename
```








```{r}
colMeans(out) # K10_r0p5_sd3p6

# # Finished at: 12:59 AM 
# Finished at: 12:57 PM 
# Runtime for this case: 189.97 minutes

```

```{r}
r <- 0.9
sd <- 2.00 
K <- 10


```


```{r}
colMeans(out) # K10_r0p1_sd3p6

# # Finished at: 12:59 AM 
# Finished at: 12:57 PM 
# Runtime for this case: 189.97 minutes

```

```{r}
colMeans(out)
```


```{r}
# Runtime for this case: 189.65 minutes K10_r0p9_sd2p0
# Runtime for this case: 195.53 minutes K10_r0p5_sd2p0
# Runtime for this case: 189.8 minutes K10_r0p1_sd2p0

colMeans(out) # K10_r0p9_sd2p0
```

```{r}
colMeans(out) # K10_r0p5_sd2p0
# Finished at: 12:59 AM 
```

```{r}
saveRDS(out, file = "K10_r0p5_sd3p6.rds")
```

